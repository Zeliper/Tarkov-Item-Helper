# Player Level Filter PRD (í”Œë ˆì´ì–´ ë ˆë²¨ í•„í„°)

## Status: IMPLEMENTED

## Overview
í”Œë ˆì´ì–´ ë ˆë²¨ì„ ì…ë ¥ë°›ì•„ í•´ë‹¹ ë ˆë²¨ì—ì„œ ì§„í–‰ ê°€ëŠ¥í•œ í€˜ìŠ¤íŠ¸ë§Œ Activeë¡œ í‘œì‹œí•˜ëŠ” ê¸°ëŠ¥ êµ¬í˜„. ìš°ì¸¡ ìƒë‹¨ì— +/- ë²„íŠ¼ì´ ìˆëŠ” ë ˆë²¨ ì…ë ¥ë€ì„ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©ìê°€ ì‰½ê²Œ ë ˆë²¨ì„ ì¡°ì •í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

## Reference
- ê¸°ì¡´ ì„œë¹„ìŠ¤: `QuestProgressService.cs`, `QuestGraphService.cs`
- ê´€ë ¨ ëª¨ë¸: `TarkovTask.cs` (`RequiredLevel` í•„ë“œ)
- UI: `MainWindow.xaml`, `QuestListPage.xaml`

---

## Features

### 1. Player Level Input (í”Œë ˆì´ì–´ ë ˆë²¨ ì…ë ¥)

#### 1.1 UI Location
- ìœ„ì¹˜: ìš°ì¸¡ ìƒë‹¨ íƒ€ì´í‹€ ë°”, ì–¸ì–´ ì„ íƒê¸° ì™¼ìª½
- ê¸°ì¡´ ë²„íŠ¼ë“¤(â˜• Support, ğŸ”„ Refresh, â†© Reset, âš™)ê³¼ ê°™ì€ ì˜ì—­

#### 1.2 UI Components
```
+-----------------------------------+
| [-] [ë ˆë²¨ ìˆ«ì] [+]  |  ğŸ”„  â†©  âš™  EN â–¼ |
+-----------------------------------+
```

- **Decrement Button (-)**: ë ˆë²¨ 1 ê°ì†Œ
- **Level Display**: í˜„ì¬ ë ˆë²¨ í‘œì‹œ (ìˆ«ì)
- **Increment Button (+)**: ë ˆë²¨ 1 ì¦ê°€

#### 1.3 Level Range
- ìµœì†Œ: 1
- ìµœëŒ€: 79 (íƒ€ë¥´ì½”í”„ ìµœëŒ€ ë ˆë²¨)
- ê¸°ë³¸ê°’: 15 (ì²« ì‹¤í–‰ ì‹œ)

#### 1.4 Behavior
- +/- ë²„íŠ¼ í´ë¦­ ì‹œ ë ˆë²¨ 1ì”© ì¦ê°
- ë ˆë²¨ ìˆ«ì ì§ì ‘ í´ë¦­ ì‹œ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜ ê°€ëŠ¥ (ì„ íƒì‚¬í•­)
- ìµœì†Œ/ìµœëŒ€ ë ˆë²¨ì—ì„œëŠ” í•´ë‹¹ ë°©í–¥ ë²„íŠ¼ ë¹„í™œì„±í™”
- ë ˆë²¨ ë³€ê²½ ì‹œ ì¦‰ì‹œ í€˜ìŠ¤íŠ¸ ëª©ë¡ ì—…ë°ì´íŠ¸

### 2. Quest Level Filtering (í€˜ìŠ¤íŠ¸ ë ˆë²¨ í•„í„°ë§)

#### 2.1 Level Requirement Check
ê° í€˜ìŠ¤íŠ¸ì˜ `RequiredLevel` í•„ë“œë¥¼ í˜„ì¬ í”Œë ˆì´ì–´ ë ˆë²¨ê³¼ ë¹„êµ:

```csharp
// ë ˆë²¨ ìš”êµ¬ì‚¬í•­ ì¶©ì¡± ì—¬ë¶€
bool IsLevelRequirementMet(TarkovTask task, int playerLevel)
{
    if (!task.RequiredLevel.HasValue)
        return true;  // ë ˆë²¨ ìš”êµ¬ì‚¬í•­ ì—†ìŒ

    return playerLevel >= task.RequiredLevel.Value;
}
```

#### 2.2 Quest Status with Level
ê¸°ì¡´ QuestStatusì— ë ˆë²¨ ì¡°ê±´ ì¶”ê°€:

| ê¸°ì¡´ ìƒíƒœ | ë ˆë²¨ ì¶©ì¡± | ìµœì¢… ìƒíƒœ |
|-----------|-----------|-----------|
| Locked | - | Locked (ë³€ê²½ ì—†ìŒ) |
| Active | O | Active |
| Active | X | Level Locked (ì‹ ê·œ) |
| Done | - | Done (ë³€ê²½ ì—†ìŒ) |
| Failed | - | Failed (ë³€ê²½ ì—†ìŒ) |

#### 2.3 Level Locked Status
- ì„ í–‰ í€˜ìŠ¤íŠ¸ëŠ” ëª¨ë‘ ì™„ë£Œí–ˆìœ¼ë‚˜ ë ˆë²¨ì´ ë¶€ì¡±í•œ í€˜ìŠ¤íŠ¸
- UIì—ì„œ "Lv.XX Required" í˜•íƒœë¡œ í‘œì‹œ
- ê¸°ì¡´ Lockedì™€ ë‹¤ë¥¸ ì‹œê°ì  êµ¬ë¶„ (ìƒ‰ìƒ ë˜ëŠ” ì•„ì´ì½˜)

### 3. UI Integration

#### 3.1 Quest List Display
ë ˆë²¨ í•„í„° ì ìš© ì‹œ í€˜ìŠ¤íŠ¸ ëª©ë¡ ë³€í™”:

```
ê¸°ë³¸ ë·° (Activeë§Œ í‘œì‹œ):
- ë ˆë²¨ ì¶©ì¡± + Active â†’ í‘œì‹œ
- ë ˆë²¨ ë¯¸ì¶©ì¡± + Active â†’ "Level Locked" ë°°ì§€ì™€ í•¨ê»˜ í‘œì‹œ ë˜ëŠ” ìˆ¨ê¹€ (ì„¤ì • ê°€ëŠ¥)

ì „ì²´ ë·°:
- ëª¨ë“  í€˜ìŠ¤íŠ¸ì— ë ˆë²¨ ìš”êµ¬ì‚¬í•­ í‘œì‹œ (í•´ë‹¹ë˜ëŠ” ê²½ìš°)
```

#### 3.2 Quest Detail Panel
ì„ íƒëœ í€˜ìŠ¤íŠ¸ ìƒì„¸ ì •ë³´ì— ë ˆë²¨ ìš”êµ¬ì‚¬í•­ í‘œì‹œ:

```
+----------------------------+
| Quest Name                 |
+----------------------------+
| Prerequisites              |
| - Level: 15 âš  (í˜„ì¬: 12)   |  <- ë¯¸ì¶©ì¡± ì‹œ ê²½ê³ 
| - Quest A (Done)           |
| - Quest B (Active)         |
+----------------------------+
```

#### 3.3 Filter Options
í€˜ìŠ¤íŠ¸ í•„í„° ì˜ì—­ì— ë ˆë²¨ ê´€ë ¨ ì˜µì…˜ ì¶”ê°€:

- [x] Show Level Locked quests (ë ˆë²¨ ë¶€ì¡± í€˜ìŠ¤íŠ¸ í‘œì‹œ)
- ê¸°ë³¸ê°’: ì²´í¬ (í‘œì‹œ)

### 4. Data Persistence

#### 4.1 Settings Storage
`appsettings.json` ë˜ëŠ” ë³„ë„ ì„¤ì • íŒŒì¼ì— ì €ì¥:

```json
{
  "playerLevel": 15,
  "showLevelLockedQuests": true
}
```

#### 4.2 Auto-save
- ë ˆë²¨ ë³€ê²½ ì‹œ ìë™ ì €ì¥
- ì•± ì¬ì‹œì‘ ì‹œ ë§ˆì§€ë§‰ ì„¤ì • ë³µì›

---

## Bug Fix: Quest Sync Started Status Issue

### Issue Description
í€˜ìŠ¤íŠ¸ ë™ê¸°í™” ì‹œ "Started" (ì§„í–‰ì¤‘, message.type == 10) ìƒíƒœì˜ í€˜ìŠ¤íŠ¸ê°€ ë‹¤ë¥¸ í€˜ìŠ¤íŠ¸ì˜ ì„ í–‰ í€˜ìŠ¤íŠ¸ë¡œ íŒë‹¨ë˜ì–´ ìë™ìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬ë˜ëŠ” ë²„ê·¸.

### Current Behavior (ë²„ê·¸)
```
ë¡œê·¸ ì´ë²¤íŠ¸ ìˆœì„œ:
1. Quest A Started (type 10)
2. Quest B Started (type 10) - Quest Aê°€ Quest Bì˜ ì„ í–‰ í€˜ìŠ¤íŠ¸ì¸ ê²½ìš°

í˜„ì¬ ë™ì‘:
- Quest B Started ì²˜ë¦¬ ì‹œ
- Quest Aê°€ ì„ í–‰ í€˜ìŠ¤íŠ¸ë¡œ ê°ì§€ë¨
- Quest A ìƒíƒœê°€ Doneì´ ì•„ë‹ˆë¯€ë¡œ ìë™ ì™„ë£Œ ì²˜ë¦¬ë¨ â† ë²„ê·¸!
- Quest AëŠ” ì•„ì§ ì§„í–‰ì¤‘(Started)ì¸ë° ì™„ë£Œ ì²˜ë¦¬ë¨
```

### Root Cause
`LogSyncService.cs`ì˜ `SyncFromLogsAsync` ë©”ì„œë“œì—ì„œ:

```csharp
// í˜„ì¬ ì½”ë“œ (406-432ë²ˆ ë¼ì¸ ê·¼ì²˜)
case QuestEventType.Started:
    // ...
    foreach (var prereq in prereqs)
    {
        var currentStatus = progressService.GetStatus(prereq);
        if (currentStatus != QuestStatus.Done)  // ë¬¸ì œ: Active ìƒíƒœë„ ì™„ë£Œ ì²˜ë¦¬ë¨
        {
            // ì™„ë£Œ ì²˜ë¦¬
        }
    }
```

### Expected Behavior (ìˆ˜ì • í›„)
- Started ì´ë²¤íŠ¸ê°€ ìˆëŠ” í€˜ìŠ¤íŠ¸ëŠ” ìë™ ì™„ë£Œ ëŒ€ìƒì—ì„œ ì œì™¸
- ëª…ì‹œì ìœ¼ë¡œ Completed ì´ë²¤íŠ¸(type 12)ê°€ ìˆëŠ” í€˜ìŠ¤íŠ¸ë§Œ ì™„ë£Œ ì²˜ë¦¬

### Solution

#### Option 1: Track Started Quests (ê¶Œì¥)
ì‹œì‘ëœ í€˜ìŠ¤íŠ¸ ëª©ë¡ì„ ë³„ë„ë¡œ ì¶”ì í•˜ì—¬ ìë™ì™„ë£Œì—ì„œ ì œì™¸:

```csharp
// ì‹œì‘ëœ í€˜ìŠ¤íŠ¸ ì¶”ì 
var startedQuests = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

// ì´ë²¤íŠ¸ ì²˜ë¦¬ ì „ Started ì´ë²¤íŠ¸ ë¨¼ì € ìˆ˜ì§‘
foreach (var evt in events.Where(e => e.EventType == QuestEventType.Started))
{
    var task = FindTaskByQuestId(tasksByQuestId, evt.QuestId);
    if (task?.NormalizedName != null)
        startedQuests.Add(task.NormalizedName);
}

// Started ì²˜ë¦¬ ì‹œ ì„ í–‰ í€˜ìŠ¤íŠ¸ ìë™ì™„ë£Œ
case QuestEventType.Started:
    foreach (var prereq in prereqs)
    {
        if (prereq.NormalizedName == null) continue;
        if (processedQuests.Contains(prereq.NormalizedName)) continue;
        if (startedQuests.Contains(prereq.NormalizedName)) continue;  // ì¶”ê°€: Started ì œì™¸

        var currentStatus = progressService.GetStatus(prereq);
        if (currentStatus != QuestStatus.Done)
        {
            // ì™„ë£Œ ì²˜ë¦¬
        }
    }
```

#### Option 2: Check Current Active Status
í˜„ì¬ UI ìƒíƒœê°€ Activeì¸ í€˜ìŠ¤íŠ¸ë„ ì œì™¸:

```csharp
var currentStatus = progressService.GetStatus(prereq);
if (currentStatus != QuestStatus.Done && currentStatus != QuestStatus.Active)
{
    // Locked ìƒíƒœì¸ ê²½ìš°ë§Œ ì™„ë£Œ ì²˜ë¦¬
}
```

### Test Cases
1. Quest A Started â†’ Quest B Started (AëŠ” Bì˜ ì„ í–‰)
   - ì˜ˆìƒ: AëŠ” Active ìœ ì§€, Bë„ Active
   - ë²„ê·¸: Aê°€ Doneìœ¼ë¡œ ë³€ê²½ë¨

2. Quest A Completed â†’ Quest B Started (AëŠ” Bì˜ ì„ í–‰)
   - ì˜ˆìƒ: AëŠ” Done, BëŠ” Active
   - ì •ìƒ ë™ì‘

3. Quest B Started (AëŠ” Bì˜ ì„ í–‰, AëŠ” ë¡œê·¸ì— ì—†ìŒ)
   - ì˜ˆìƒ: AëŠ” Done (ì•”ë¬µì  ì™„ë£Œ), BëŠ” Active
   - ì •ìƒ ë™ì‘ ìœ ì§€

---

## UI Layout (Updated Header)

```
+------------------------------------------------------------------+
| TARKOV HELPER           [-][15][+] â˜• ğŸ”„ â†© âš™  [ENâ–¼]              |
+------------------------------------------------------------------+
|  Quests  |  Hideout  |  Items                                     |
+------------------------------------------------------------------+
```

### Level Control Style
```
+-------------------+
|  Lv.  [-] 15 [+]  |
+-------------------+
```

- "Lv." ë¼ë²¨ í‘œì‹œ (ì„ íƒì‚¬í•­)
- ë ˆë²¨ ìˆ«ìëŠ” êµµê²Œ í‘œì‹œ
- +/- ë²„íŠ¼ì€ ì‘ê³  ì»´íŒ©íŠ¸í•˜ê²Œ

---

## Implementation Priority

### Phase 1: Bug Fix âœ… DONE
1. âœ… `LogSyncService.cs` Started í€˜ìŠ¤íŠ¸ ì¶”ì  ë¡œì§ ì¶”ê°€
2. âœ… ì„ í–‰ í€˜ìŠ¤íŠ¸ ìë™ì™„ë£Œ ì‹œ Started ì œì™¸ ì¡°ê±´ ì¶”ê°€
3. âœ… í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ê²€ì¦

**êµ¬í˜„ ë‚´ìš©:**
- `SyncFromLogsAsync()` ë©”ì„œë“œì— `startedQuests` HashSet ì¶”ê°€
- Started ì´ë²¤íŠ¸ê°€ ìˆëŠ” í€˜ìŠ¤íŠ¸ëŠ” ì„ í–‰ í€˜ìŠ¤íŠ¸ ìë™ì™„ë£Œì—ì„œ ì œì™¸

### Phase 2: Player Level UI âœ… DONE
1. âœ… `MainWindow.xaml` ë ˆë²¨ ì…ë ¥ UI ì»´í¬ë„ŒíŠ¸ ì¶”ê°€
2. âœ… ë ˆë²¨ ì¦ê° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ êµ¬í˜„
3. âœ… ì„¤ì • ì €ì¥/ë¡œë“œ ë¡œì§

**êµ¬í˜„ ë‚´ìš©:**
- ìš°ì¸¡ ìƒë‹¨ì— `Lv. [-] 15 [+]` í˜•íƒœì˜ ë ˆë²¨ ì»¨íŠ¸ë¡¤ ì¶”ê°€
- `SettingsService.cs`ì— `PlayerLevel`, `ShowLevelLockedQuests` ì†ì„± ì¶”ê°€
- `app_settings.json`ì— ë ˆë²¨ ì„¤ì • ìë™ ì €ì¥/ë¡œë“œ

### Phase 3: Level Filtering âœ… DONE
1. âœ… `QuestProgressService`ì— ë ˆë²¨ í•„í„° ë¡œì§ ì¶”ê°€
2. âœ… í€˜ìŠ¤íŠ¸ ëª©ë¡ UI ì—…ë°ì´íŠ¸ (Level Locked í‘œì‹œ)
3. âœ… í€˜ìŠ¤íŠ¸ ìƒì„¸ íŒ¨ë„ì— ë ˆë²¨ ìš”êµ¬ì‚¬í•­ í‘œì‹œ

**êµ¬í˜„ ë‚´ìš©:**
- `QuestStatus` enumì— `LevelLocked` ìƒíƒœ ì¶”ê°€
- `QuestProgressService.GetStatus()`ì—ì„œ ë ˆë²¨ ì²´í¬ ë¡œì§ ì¶”ê°€
- `QuestProgressService.IsLevelRequirementMet()` ë©”ì„œë“œ ì¶”ê°€
- `QuestListPage`ì— LevelLocked ìƒíƒœì— ëŒ€í•œ UI ì²˜ë¦¬ (ì£¼í™©ìƒ‰ ë°°ì§€)
- ìƒíƒœ í•„í„°ì— "Level Locked" ì˜µì…˜ ì¶”ê°€
- í†µê³„ í‘œì‹œì— í˜„ì¬ ë ˆë²¨ ë° Level Locked í€˜ìŠ¤íŠ¸ ìˆ˜ í‘œì‹œ
- ìƒì„¸ íŒ¨ë„ì— í˜„ì¬ ë ˆë²¨ê³¼ ìš”êµ¬ ë ˆë²¨ ë¹„êµ í‘œì‹œ (ë ˆë²¨ ë¯¸ì¶©ì¡± ì‹œ ì£¼í™©ìƒ‰)

### Phase 4: Polish â³ OPTIONAL
1. â¬œ UI ìŠ¤íƒ€ì¼ ì •ë¦¬
2. â¬œ ë ˆë²¨ ë¶€ì¡± í€˜ìŠ¤íŠ¸ í‘œì‹œ/ìˆ¨ê¹€ ì˜µì…˜ (ShowLevelLockedQuests ì„¤ì • ì¤€ë¹„ë¨)
3. âœ… ë ˆë²¨ ìš”êµ¬ì‚¬í•­ ì‹œê°ì  ê°•ì¡°

---

## Dependencies

### Existing
- `QuestProgressService` - í€˜ìŠ¤íŠ¸ ì§„í–‰ ìƒíƒœ ê´€ë¦¬
- `QuestGraphService` - í€˜ìŠ¤íŠ¸ ì„ í–‰ ê´€ê³„ ì¡°íšŒ
- `TarkovTask.RequiredLevel` - ë ˆë²¨ ìš”êµ¬ì‚¬í•­ ë°ì´í„°

### New
- `PlayerSettingsService` (ì„ íƒ) - í”Œë ˆì´ì–´ ë ˆë²¨ ë“± ì„¤ì • ê´€ë¦¬
  - ë˜ëŠ” ê¸°ì¡´ ì„¤ì • ì‹œìŠ¤í…œì— í†µí•©

---

## Notes

### Level Data Source
- `TarkovTask.RequiredLevel` í•„ë“œëŠ” Wiki íŒŒì‹±ì„ í†µí•´ ì±„ì›Œì§
- ì¼ë¶€ í€˜ìŠ¤íŠ¸ëŠ” ë ˆë²¨ ìš”êµ¬ì‚¬í•­ì´ ì—†ì„ ìˆ˜ ìˆìŒ (null)
- ë ˆë²¨ ìš”êµ¬ì‚¬í•­ì´ ì—†ëŠ” í€˜ìŠ¤íŠ¸ëŠ” ë ˆë²¨ í•„í„° ì˜í–¥ ì—†ìŒ

### Localization
- "Lv." ë˜ëŠ” "Level" í‘œê¸°ëŠ” ì–¸ì–´ ì„¤ì •ì— ë”°ë¼ ë³€ê²½
  - EN: "Lv."
  - KO: "ë ˆë²¨" ë˜ëŠ” "Lv."
  - JA: "Lv."

---

## Changed Files (Implementation Summary)

### Models
- `Models/QuestStatus.cs` - Added `LevelLocked` enum value

### Services
- `Services/LogSyncService.cs` - Bug fix: Track started quests to exclude from auto-completion
- `Services/QuestProgressService.cs` - Added `IsLevelRequirementMet()`, updated `GetStatus()` with level check, updated `GetStatistics()` to include LevelLocked count
- `Services/SettingsService.cs` - Added `PlayerLevel`, `ShowLevelLockedQuests` properties and constants

### UI
- `MainWindow.xaml` - Added player level control (Lv. [-][15][+])
- `MainWindow.xaml.cs` - Added level change handlers and UI update logic
- `Pages/QuestListPage.xaml` - Added "Level Locked" status filter option
- `Pages/QuestListPage.xaml.cs` - Added LevelLocked status UI handling, updated statistics display

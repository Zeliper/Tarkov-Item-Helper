# Tarkov Market Marker Data Migration PRD
## Version 1.0 | 2025-12-11

---

## 1. Overview

### 1.1 Purpose
맵 마커 데이터 소스를 tarkov.dev API에서 Tarkov Market API로 전환하기 위한 Product Requirements Document.

### 1.2 Background
기존 맵 트래커는 tarkov.dev API에서 퀘스트 위치 데이터를 가져왔으나, Tarkov Market API가 더 정확하고 최신 데이터를 제공합니다. Tarkov Market에서 추출한 SVG 맵 파일과 동일한 좌표 체계를 사용하므로 마커 데이터도 Tarkov Market에서 가져오는 것이 합리적입니다.

### 1.3 Goals
1. 마커 데이터를 Tarkov Market API에서 가져오도록 전환
2. Woods, Customs 등 기존에 누락되었던 맵의 마커 표시
3. 7일 캐시 만료 시 자동 백그라운드 갱신
4. 기존 QuestObjectiveService 의존성 제거

---

## 2. Problem Statement

### 2.1 기존 문제점
- Woods, Customs 맵에서 마커가 표시되지 않음
- tarkov.dev API 데이터가 Tarkov Market SVG 좌표와 일치하지 않음
- 캐시 파일에 일부 맵 데이터 누락

### 2.2 근본 원인
- tarkov_market_markers.json 캐시 파일에 woods, customs 키가 없었음
- 기존 좌표 변환 로직이 tarkov.dev 좌표 기반으로 구현됨

---

## 3. Implementation

### 3.1 New Components

#### TarkovMarketMarkerService
**파일:** `Services/MapTracker/TarkovMarketMarkerService.cs`

**기능:**
- Tarkov Market API 마커 데이터 관리
- 7일 캐시 만료 및 자동 갱신
- 맵 키 → API 맵 이름 매핑
- 퀘스트/탈출구 마커 필터링
- 게임 좌표 ↔ Tarkov Market 좌표 변환

**주요 속성:**
```csharp
public bool IsLoaded { get; }
public DateTime? CacheLastUpdated { get; }
public bool IsCacheExpired { get; }  // 7일 초과 시 true
public int TotalMarkerCount { get; }
```

**주요 메서드:**
```csharp
public async Task EnsureLoadedAsync(Action<string>? progressCallback = null)
public List<TarkovMarketMarker> GetMarkersForMap(string mapKey)
public List<TarkovMarketMarker> GetQuestMarkersForMap(string mapKey)
public List<TarkovMarketMarker> GetExtractMarkersForMap(string mapKey)
public List<TarkovMarketMarker> GetActiveQuestMarkersForMap(string mapKey, QuestProgressService progressService, bool hideCompleted = false)
```

### 3.2 Model Updates

#### TarkovMarketData.cs 수정
**FlexibleIntConverter 추가:**
- `level` 필드가 빈 문자열(`""`)인 경우 파싱 오류 발생
- 44개 마커(주로 customs, woods)에서 빈 문자열 level 값 발견
- `FlexibleIntConverter` 클래스로 `int`, `string`, `null` 모두 처리

```csharp
[JsonPropertyName("level")]
[JsonConverter(typeof(FlexibleIntConverter))]
public int? Level { get; set; }
```

### 3.3 MapTrackerPage 수정

#### QuestObjectiveService 의존성 제거
- `_objectiveService` 필드 제거
- `_tmMarkerService.IsLoaded` 조건으로 대체
- 레거시 fallback 코드 제거

#### 상태 표시 개선
```csharp
var cacheInfo = _tmMarkerService.CacheLastUpdated.HasValue
    ? $" (Updated: {_tmMarkerService.CacheLastUpdated:yyyy-MM-dd})"
    : "";
TxtStatus.Text = $"{_tmMarkerService.TotalMarkerCount} markers loaded{cacheInfo}";
```

---

## 4. Data Flow

### 4.1 Before (tarkov.dev)
```
tarkov.dev GraphQL API
    ↓
QuestObjectiveService (quest locations)
    ↓
MapTrackerPage (marker rendering)
```

### 4.2 After (Tarkov Market)
```
Tarkov Market REST API
    ↓
TarkovMarketMarkerService (markers/list endpoint)
    ↓
Local Cache (tarkov_market_markers.json)
    ↓
MapTrackerPage (marker rendering)
```

### 4.3 Cache Management
```
앱 시작
    ↓
캐시 파일 확인
    ↓
[캐시 있음] → 로드 → [7일 초과?] → 백그라운드 갱신
    ↓                    [아니오] → 사용
[캐시 없음] → API 요청 → 캐시 저장 → 로드
```

---

## 5. Marker Statistics

### 5.1 Total Markers by Map

| Map | Marker Count |
|-----|-------------|
| customs | 582 |
| factory | 207 |
| interchange | 605 |
| labs | 0 |
| lighthouse | 187 |
| reserve | 511 |
| shoreline | 673 |
| streets | 214 |
| woods | 453 |
| ground-zero | 383 |
| **Total** | **3,815** |

### 5.2 Markers by Category
- Quests: ~1,200+
- Extractions: ~200+
- Spawns, Loot, etc.: ~2,400+

---

## 6. Map Key Mapping

```csharp
private static readonly Dictionary<string, string> MapKeyToApiName = new()
{
    { "Customs", "customs" },
    { "Woods", "woods" },
    { "Factory", "factory" },
    { "Interchange", "interchange" },
    { "Reserve", "reserve" },
    { "Shoreline", "shoreline" },
    { "Labs", "labs" },
    { "Lighthouse", "lighthouse" },
    { "StreetsOfTarkov", "streets" },
    { "GroundZero", "ground-zero" },
    // Aliases
    { "bigmap", "customs" },
    { "TarkovStreets", "streets" },
    { "streets-of-tarkov", "streets" },
    { "ground-zero-21", "ground-zero" },
    { "Sandbox", "ground-zero" },
    { "laboratory", "labs" },
    { "the-lab", "labs" },
    { "RezervBase", "reserve" },
    { "factory4_day", "factory" },
    { "factory4_night", "factory" }
};
```

---

## 7. Files Changed

### 7.1 New Files

| File | Description |
|------|-------------|
| `Services/MapTracker/TarkovMarketMarkerService.cs` | Tarkov Market 마커 관리 서비스 |

### 7.2 Modified Files

| File | Changes |
|------|---------|
| `Models/TarkovMarketData.cs` | FlexibleIntConverter 추가, Level 속성에 적용 |
| `Pages/MapTrackerPage.xaml.cs` | QuestObjectiveService 의존성 제거, TarkovMarketMarkerService 사용 |
| `Services/QuestProgressService.cs` | GetTaskByBsgId 메서드 추가 |

### 7.3 Cache Files

| File | Description |
|------|-------------|
| `Data/tarkov_market_markers.json` | 마커 캐시 (10개 맵, 3,815 마커) |
| `Data/tarkov_market_quests.json` | 퀘스트 정보 캐시 (bsgId 매핑용) |

---

## 8. Testing

### 8.1 Verification Complete
- [x] 빌드 성공 (경고만 있음, 오류 없음)
- [x] Woods 맵 마커 표시 (453개)
- [x] Customs 맵 마커 표시 (582개)
- [x] 캐시 만료 시 백그라운드 갱신 동작

### 8.2 Known Warnings
```
CS0067: 'TarkovMarketMarkerService.DataRefreshed' 이벤트가 사용되지 않았습니다.
CS1998: 비동기 메서드에 'await' 연산자가 없습니다. (CollectorPage, ItemsPage)
```

---

## 9. Future Improvements

### 9.1 Pending Tasks
- [ ] UI에 'Powered by Tarkov Market' 표시 추가
- [ ] Quest Drawer 기능 TarkovMarketMarker 기반으로 구현
- [ ] 미사용 DataRefreshed 이벤트 활용 또는 제거

### 9.2 Potential Enhancements
- Tarkov Market 퀘스트 bsgId ↔ tarkov.dev taskId 매핑 개선
- 마커 카테고리별 필터 UI 추가
- 캐시 갱신 시간 설정 옵션

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-11 | Claude | Initial document creation |

<UserControl x:Class="TarkovHelper.Pages.MapTrackerPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:svgc="http://sharpvectors.codeplex.com/svgc/"
             xmlns:local="clr-namespace:TarkovHelper.Pages"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1200"
             Background="#0D0D0D"
             Loaded="MapTrackerPage_Loaded"
             Unloaded="MapTrackerPage_Unloaded">

    <UserControl.Resources>
        <!-- ========== COLOR SYSTEM ========== -->
        <SolidColorBrush x:Key="BgL0" Color="#0D0D0D"/>
        <SolidColorBrush x:Key="BgL1" Color="#141414"/>
        <SolidColorBrush x:Key="BgL2" Color="#1A1A1A"/>
        <SolidColorBrush x:Key="BgL3" Color="#242424"/>
        <SolidColorBrush x:Key="BgHover" Color="#2E2E2E"/>
        <SolidColorBrush x:Key="BorderSubtle" Color="#2A2A2A"/>
        <SolidColorBrush x:Key="BorderNormal" Color="#3A3A3A"/>
        <SolidColorBrush x:Key="TextPrimary" Color="#E8E8E8"/>
        <SolidColorBrush x:Key="TextSecondary" Color="#888888"/>
        <SolidColorBrush x:Key="TextMuted" Color="#555555"/>
        <SolidColorBrush x:Key="Accent" Color="#00B4D8"/>
        <SolidColorBrush x:Key="AccentHover" Color="#48CAE4"/>
        <SolidColorBrush x:Key="Success" Color="#10B981"/>
        <SolidColorBrush x:Key="Warning" Color="#F59E0B"/>
        <SolidColorBrush x:Key="Danger" Color="#EF4444"/>

        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <local:ProgressToWidthConverter x:Key="ProgressToWidthConverter"/>

        <!-- Marker Colors -->
        <SolidColorBrush x:Key="MarkerExtract" Color="#22C55E"/>
        <SolidColorBrush x:Key="MarkerScavExtract" Color="#86EFAC"/>
        <SolidColorBrush x:Key="MarkerSharedExtract" Color="#14B8A6"/>
        <SolidColorBrush x:Key="MarkerTransit" Color="#3B82F6"/>
        <SolidColorBrush x:Key="MarkerSpawn" Color="#FACC15"/>
        <SolidColorBrush x:Key="MarkerBoss" Color="#EF4444"/>
        <SolidColorBrush x:Key="MarkerLever" Color="#A1A1AA"/>
        <SolidColorBrush x:Key="MarkerKey" Color="#F97316"/>
        <SolidColorBrush x:Key="PlayerMarker" Color="#06B6D4"/>

        <!-- NEW: Quest Marker Colors (Redesigned) -->
        <Color x:Key="QuestRequiredColor">#F5A623</Color>
        <Color x:Key="QuestOptionalColor">#9E9E9E</Color>
        <Color x:Key="QuestCompletedColor">#4CAF50</Color>
        <Color x:Key="QuestClusterColor">#FF7043</Color>
        <SolidColorBrush x:Key="MarkerQuest" Color="#F5A623"/>
        <SolidColorBrush x:Key="QuestRequiredBrush" Color="{StaticResource QuestRequiredColor}" Opacity="0.85"/>
        <SolidColorBrush x:Key="QuestOptionalBrush" Color="{StaticResource QuestOptionalColor}" Opacity="0.70"/>
        <SolidColorBrush x:Key="QuestClusterBrush" Color="{StaticResource QuestClusterColor}"/>

        <!-- ========== BUTTON STYLES ========== -->
        <Style x:Key="IconButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="36"/>
            <Setter Property="Height" Value="36"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}" CornerRadius="6">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource BgHover}"/>
                                <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource BgL3}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="FloatingPanelStyle" TargetType="Border">
            <Setter Property="Background" Value="#F0141414"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderSubtle}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="16" ShadowDepth="2" Opacity="0.4" Color="Black"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Layer Chip Style (Bottom Bar) -->
        <Style x:Key="LayerChipStyle" TargetType="ToggleButton">
            <Setter Property="Height" Value="30"/>
            <Setter Property="Padding" Value="12,0"/>
            <Setter Property="Margin" Value="3,0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="Bd" CornerRadius="15" Padding="{TemplateBinding Padding}"
                                Background="#40000000" BorderThickness="1" BorderBrush="Transparent">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#50FFFFFF"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#60FFFFFF"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.5"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Opacity" Value="1"/>
                                <Setter TargetName="Bd" Property="Background" Value="#60000000"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="TrackingButtonStyle" TargetType="Button">
            <Setter Property="Height" Value="28"/>
            <Setter Property="Padding" Value="12,0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}"
                                CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="QuestItemStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource BgL3}"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Margin" Value="0,0,0,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource BgHover}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Quest Card Style (for grouped quest cards) -->
        <Style x:Key="QuestCardStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource BgL3}"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="Margin" Value="0,0,0,4"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource BgHover}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Objective Item Style (for expanded objectives) -->
        <Style x:Key="ObjectiveItemStyle" TargetType="Border">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="4,3"/>
            <Setter Property="Margin" Value="0,1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#20FFFFFF"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Progress Bar Style -->
        <Style x:Key="QuestProgressBarStyle" TargetType="ProgressBar">
            <Setter Property="Height" Value="3"/>
            <Setter Property="Background" Value="{StaticResource BgL1}"/>
            <Setter Property="Foreground" Value="{StaticResource Accent}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ProgressBar">
                        <Grid>
                            <Border Background="{TemplateBinding Background}" CornerRadius="1.5"/>
                            <Border x:Name="PART_Indicator" HorizontalAlignment="Left" CornerRadius="1.5"
                                    Background="{TemplateBinding Foreground}"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="40"/>   <!-- Compact Header -->
            <RowDefinition Height="*"/>    <!-- Map + Floating Elements -->
            <RowDefinition Height="32"/>   <!-- Compact Status Bar -->
        </Grid.RowDefinitions>

        <!-- ==================== COMPACT HEADER (40px) ==================== -->
        <Border Grid.Row="0" Background="{StaticResource BgL2}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="0,0,0,1">
            <Grid Margin="8,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>  <!-- Map Selector -->
                    <ColumnDefinition Width="*"/>     <!-- Spacer -->
                    <ColumnDefinition Width="Auto"/>  <!-- Search -->
                    <ColumnDefinition Width="Auto"/>  <!-- Floor -->
                    <ColumnDefinition Width="Auto"/>  <!-- Actions -->
                </Grid.ColumnDefinitions>

                <!-- Map Selector -->
                <ComboBox x:Name="MapSelector" Grid.Column="0" Width="140" Height="28" Margin="0,0,8,0"
                          Background="{StaticResource BgL3}" Foreground="{StaticResource TextPrimary}"
                          BorderBrush="{StaticResource BorderSubtle}"
                          SelectionChanged="MapSelector_SelectionChanged">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding DisplayName}"/>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <!-- Search Box -->
                <Border Grid.Column="2" Width="200" Height="28" CornerRadius="4"
                        Background="{StaticResource BgL3}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="&#x1F50D;" FontSize="11" Foreground="{StaticResource TextMuted}"
                                   VerticalAlignment="Center" Margin="8,0,6,0"/>
                        <TextBox x:Name="TxtSearch" Grid.Column="1" Background="Transparent" BorderThickness="0"
                                 Foreground="{StaticResource TextPrimary}" VerticalAlignment="Center"
                                 TextChanged="TxtSearch_TextChanged"/>
                        <Button x:Name="BtnClearSearch" Grid.Column="2" Width="24" Height="24"
                                Style="{StaticResource IconButtonStyle}" Visibility="Collapsed"
                                Click="BtnClearSearch_Click">
                            <TextBlock Text="&#x2715;" FontSize="10"/>
                        </Button>
                    </Grid>
                </Border>

                <!-- Floor Selector -->
                <Border Grid.Column="3" Margin="8,0" Height="28" CornerRadius="4"
                        Background="{StaticResource BgL3}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1">
                    <StackPanel Orientation="Horizontal" Margin="8,0">
                        <TextBlock Text="Floor:" Foreground="{StaticResource TextSecondary}" FontSize="11"
                                   VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <ComboBox x:Name="FloorSelector" Width="90" Height="24"
                                  Background="Transparent" BorderThickness="0"
                                  Foreground="{StaticResource TextPrimary}"
                                  SelectionChanged="FloorSelector_SelectionChanged"/>
                    </StackPanel>
                </Border>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="4" Orientation="Horizontal">
                    <Button x:Name="BtnHelp" Style="{StaticResource IconButtonStyle}"
                            Click="BtnShowShortcuts_Click" ToolTip="Shortcuts (F1)">
                        <TextBlock Text="?" FontSize="14" FontWeight="SemiBold"/>
                    </Button>
                    <Button x:Name="BtnSettings" Style="{StaticResource IconButtonStyle}"
                            Click="BtnToggleSettings_Click" ToolTip="Settings (,)">
                        <TextBlock Text="&#x2699;" FontSize="14"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ==================== MAIN MAP AREA ==================== -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="QuestPanelColumn" Width="260" MinWidth="180" MaxWidth="450"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- ===== DOCKED: Quest Panel (Left) ===== -->
            <Border x:Name="QuestPanel" Grid.Column="0"
                    Background="{StaticResource BgL1}"
                    BorderBrush="{StaticResource BorderSubtle}"
                    BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Quest Panel Header -->
                    <Grid Grid.Row="0" Margin="12,12,12,10">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="QUESTS" FontSize="13" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextPrimary}" VerticalAlignment="Center"/>
                            <TextBlock x:Name="TxtQuestCount" Text="(0)" FontSize="13" FontWeight="Medium"
                                       Foreground="{StaticResource Accent}" Margin="8,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                        <Button x:Name="BtnCollapseQuests" HorizontalAlignment="Right"
                                Style="{StaticResource IconButtonStyle}" Width="28" Height="28"
                                Click="BtnCollapseQuests_Click">
                            <TextBlock x:Name="TxtQuestCollapseIcon" Text="&#x25BC;" FontSize="10"/>
                        </Button>
                    </Grid>

                    <!-- Quest Filters -->
                    <StackPanel x:Name="QuestFilters" Grid.Row="1" Margin="12,0,12,10">
                        <!-- Trader Filter Dropdown -->
                        <ComboBox x:Name="CmbPanelTraderFilter" FontSize="11" Padding="8,6"
                                  Background="{StaticResource BgL1}" Foreground="{StaticResource TextPrimary}"
                                  BorderBrush="{StaticResource BorderSubtle}" Margin="0,0,0,8"
                                  SelectionChanged="CmbPanelTraderFilter_SelectionChanged">
                            <ComboBoxItem Content="All Traders" Tag="" IsSelected="True"/>
                            <ComboBoxItem Content="Prapor" Tag="Prapor"/>
                            <ComboBoxItem Content="Therapist" Tag="Therapist"/>
                            <ComboBoxItem Content="Fence" Tag="Fence"/>
                            <ComboBoxItem Content="Skier" Tag="Skier"/>
                            <ComboBoxItem Content="Peacekeeper" Tag="Peacekeeper"/>
                            <ComboBoxItem Content="Mechanic" Tag="Mechanic"/>
                            <ComboBoxItem Content="Ragman" Tag="Ragman"/>
                            <ComboBoxItem Content="Jaeger" Tag="Jaeger"/>
                            <ComboBoxItem Content="Lightkeeper" Tag="Lightkeeper"/>
                        </ComboBox>
                        <!-- Filter Checkboxes -->
                        <CheckBox x:Name="ChkIncompleteOnly" Content="Incomplete only" IsChecked="False"
                                  Foreground="{StaticResource TextSecondary}" FontSize="11"
                                  Checked="QuestFilter_Changed" Unchecked="QuestFilter_Changed"/>
                        <CheckBox x:Name="ChkCurrentMapOnly" Content="This map only" IsChecked="True"
                                  Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,4,0,0"
                                  Checked="QuestFilter_Changed" Unchecked="QuestFilter_Changed"/>
                    </StackPanel>

                    <!-- Quest List (Card-based) -->
                    <ScrollViewer x:Name="QuestListScroll" Grid.Row="2" VerticalScrollBarVisibility="Auto"
                                  Padding="10,0">
                        <ItemsControl x:Name="QuestList">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border x:Name="CardBorder"
                                            Background="{StaticResource BgL2}"
                                            CornerRadius="8"
                                            Padding="12"
                                            Margin="0,0,0,8"
                                            BorderThickness="1"
                                            BorderBrush="Transparent"
                                            Opacity="{Binding CardOpacity}"
                                            MouseLeftButtonDown="QuestCard_Click"
                                            MouseEnter="QuestCard_MouseEnter"
                                            MouseLeave="QuestCard_MouseLeave"
                                            Tag="{Binding}"
                                            Cursor="Hand">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="{StaticResource BgL3}"/>
                                                        <Setter Property="BorderBrush" Value="{StaticResource BorderSubtle}"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <StackPanel>
                                            <!-- Card Header: Circular Progress + Quest Info + Expand -->
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="52"/>   <!-- Circular Progress -->
                                                    <ColumnDefinition Width="*"/>    <!-- Name + Trader -->
                                                    <ColumnDefinition Width="24"/>   <!-- Expand Icon -->
                                                </Grid.ColumnDefinitions>

                                                <!-- Circular Progress Gauge -->
                                                <Grid Grid.Column="0" Width="40" Height="40" VerticalAlignment="Center">
                                                    <!-- Background Track Circle -->
                                                    <Ellipse Stroke="{StaticResource BgL0}"
                                                             StrokeThickness="3.5"
                                                             Fill="Transparent"/>

                                                    <!-- Progress Arc -->
                                                    <Path Stroke="{Binding ProgressArcColor}"
                                                          StrokeThickness="3.5"
                                                          StrokeStartLineCap="Round"
                                                          StrokeEndLineCap="Round"
                                                          Fill="Transparent"
                                                          Data="{Binding ProgressArcData}"/>

                                                    <!-- Type Icon (Centered) -->
                                                    <Image Source="{Binding TypeIcon}"
                                                           Width="18" Height="18"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                                </Grid>

                                                <!-- Quest Name + Trader Subtitle -->
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="10,0,0,0">
                                                    <!-- Quest Name -->
                                                    <TextBlock Text="{Binding QuestName}"
                                                               FontSize="13"
                                                               FontWeight="SemiBold"
                                                               Foreground="{Binding QuestNameForeground}"
                                                               TextTrimming="CharacterEllipsis"
                                                               LineHeight="18"/>

                                                    <!-- Trader + Progress Subtitle -->
                                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                        <TextBlock Text="{Binding TraderName}"
                                                                   FontSize="11"
                                                                   Foreground="{StaticResource TextSecondary}"
                                                                   VerticalAlignment="Center"/>

                                                        <TextBlock Text=" Â· "
                                                                   FontSize="11"
                                                                   Foreground="{StaticResource TextMuted}"
                                                                   VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding ProgressText}"
                                                                   FontSize="11"
                                                                   FontWeight="Medium"
                                                                   Foreground="{Binding ProgressArcColor}"
                                                                   VerticalAlignment="Center"/>

                                                        <!-- Kappa Badge -->
                                                        <Border Padding="5,2"
                                                                CornerRadius="3"
                                                                Background="#9C27B0"
                                                                Margin="8,0,0,0"
                                                                Visibility="{Binding IsKappaRequired, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                VerticalAlignment="Center">
                                                            <TextBlock Text="K"
                                                                       FontSize="9"
                                                                       FontWeight="Bold"
                                                                       Foreground="White"/>
                                                        </Border>
                                                    </StackPanel>
                                                </StackPanel>

                                                <!-- Expand/Collapse Icon -->
                                                <TextBlock Grid.Column="2"
                                                           Text="{Binding ExpandIcon}"
                                                           FontSize="10"
                                                           Foreground="{StaticResource TextMuted}"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Grid>

                                            <!-- Objectives List (Expandable) -->
                                            <ItemsControl ItemsSource="{Binding Objectives}"
                                                          Visibility="{Binding ObjectivesVisibility}"
                                                          Margin="0,12,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border x:Name="ObjBorder"
                                                                Padding="10,8"
                                                                Margin="0,4"
                                                                CornerRadius="6"
                                                                Background="{StaticResource BgL1}"
                                                                Cursor="Hand"
                                                                MouseLeftButtonDown="ObjectiveItem_Click"
                                                                Tag="{Binding}"
                                                                ToolTip="{Binding FocusButtonTooltip}">
                                                            <Border.Style>
                                                                <Style TargetType="Border">
                                                                    <Style.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter Property="Background" Value="{StaticResource BgHover}"/>
                                                                        </Trigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Border.Style>
                                                            <StackPanel>
                                                                <!-- Main objective row -->
                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="24"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="20"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <!-- Objective Type Icon -->
                                                                    <Image Grid.Column="0"
                                                                           Source="{Binding TypeIcon}"
                                                                           Width="16" Height="16"
                                                                           VerticalAlignment="Center"
                                                                           Opacity="{Binding CompletedOpacity}"/>

                                                                    <!-- Objective Description -->
                                                                    <TextBlock Grid.Column="1"
                                                                               Text="{Binding Description}"
                                                                               FontSize="11"
                                                                               Foreground="{Binding CompletedForeground}"
                                                                               TextTrimming="CharacterEllipsis"
                                                                               TextDecorations="{Binding CompletedDecoration}"
                                                                               Margin="8,0,0,0"
                                                                               VerticalAlignment="Center"
                                                                               LineHeight="16"/>

                                                                    <!-- Completion Toggle Button -->
                                                                    <Border Grid.Column="2"
                                                                            Width="20" Height="20"
                                                                            CornerRadius="10"
                                                                            Background="Transparent"
                                                                            Cursor="Hand"
                                                                            MouseLeftButtonDown="ObjectiveToggle_Click"
                                                                            Tag="{Binding}"
                                                                            ToolTip="Toggle completion">
                                                                        <Border.Style>
                                                                            <Style TargetType="Border">
                                                                                <Style.Triggers>
                                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                                        <Setter Property="Background" Value="{StaticResource BgL3}"/>
                                                                                    </Trigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </Border.Style>
                                                                        <TextBlock Text="{Binding CompletionIcon}"
                                                                                   FontSize="12"
                                                                                   Foreground="{Binding CompletionColor}"
                                                                                   HorizontalAlignment="Center"
                                                                                   VerticalAlignment="Center"/>
                                                                    </Border>
                                                                </Grid>

                                                                <!-- Location info row (if has coordinates) -->
                                                                <StackPanel Orientation="Horizontal"
                                                                            Margin="32,4,0,0"
                                                                            Visibility="{Binding LocationVisibility}">
                                                                    <TextBlock Text="ðŸ“" FontSize="9" VerticalAlignment="Center"/>
                                                                    <TextBlock Text="{Binding LocationText}"
                                                                               FontSize="9"
                                                                               Foreground="{StaticResource TextMuted}"
                                                                               Margin="4,0,0,0"
                                                                               VerticalAlignment="Center"/>
                                                                </StackPanel>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- GridSplitter for resizing Quest Panel -->
            <Grid Grid.Column="1" x:Name="QuestPanelSplitterArea">
                <GridSplitter x:Name="QuestPanelSplitter" Width="4" HorizontalAlignment="Center"
                              Background="{StaticResource BorderSubtle}"
                              Cursor="SizeWE"/>
                <!-- Close button on splitter -->
                <Border HorizontalAlignment="Center" VerticalAlignment="Center"
                        Width="20" Height="60" Margin="0,0,0,0"
                        Background="#E0141414" CornerRadius="0,4,4,0"
                        Cursor="Hand"
                        MouseLeftButtonDown="BtnLeftToggleQuestPanel_Click"
                        ToolTip="Hide Quest Panel (Q)">
                    <TextBlock Text="â—€" FontSize="10" Foreground="{StaticResource TextSecondary}"
                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                </Border>
            </Grid>

            <!-- Map Viewer Area -->
            <Grid Grid.Column="2" x:Name="MapViewerGrid" Background="{StaticResource BgL1}"
                  ClipToBounds="True"
                  MouseLeftButtonDown="MapViewer_MouseLeftButtonDown"
                  MouseLeftButtonUp="MapViewer_MouseLeftButtonUp"
                  MouseMove="MapViewer_MouseMove"
                  MouseWheel="MapViewer_MouseWheel">

                <!-- Map Canvas -->
                <Canvas x:Name="MapCanvas" RenderTransformOrigin="0,0">
                    <Canvas.RenderTransform>
                        <TransformGroup>
                            <ScaleTransform x:Name="MapScale" ScaleX="1" ScaleY="1"/>
                            <TranslateTransform x:Name="MapTranslate" X="0" Y="0"/>
                        </TransformGroup>
                    </Canvas.RenderTransform>
                    <svgc:SvgViewbox x:Name="MapSvg" Stretch="None" Canvas.Left="0" Canvas.Top="0"/>
                    <Canvas x:Name="MarkersCanvas"/>
                    <Canvas x:Name="ObjectivesCanvas"/>
                    <Canvas x:Name="PlayerCanvas"/>
                </Canvas>

                <!-- ===== FLOATING: Quest Panel Toggle Button (Left) ===== -->
                <Border x:Name="BtnLeftToggleQuestPanel"
                        HorizontalAlignment="Left" VerticalAlignment="Center"
                        Width="20" Height="60" Margin="0,0,0,0"
                        Background="#E0141414" CornerRadius="0,4,4,0"
                        Cursor="Hand" Visibility="Collapsed"
                        MouseLeftButtonDown="BtnLeftToggleQuestPanel_Click"
                        ToolTip="Show Quest Panel (Q)">
                    <TextBlock Text="â–¶" FontSize="10" Foreground="{StaticResource TextSecondary}"
                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                </Border>

                <!-- ===== FLOATING: Layer Chip Bar (Bottom Center) ===== -->
            <Border x:Name="LayerChipBar"
                    HorizontalAlignment="Center" VerticalAlignment="Bottom"
                    Margin="0,0,0,12" Padding="8,6" CornerRadius="20"
                    Background="#D9101010">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="12" ShadowDepth="2" Opacity="0.3" Color="Black"/>
                </Border.Effect>
                <StackPanel Orientation="Horizontal">
                    <ToggleButton x:Name="ChipBoss" Style="{StaticResource LayerChipStyle}"
                                  IsChecked="True" Checked="LayerChip_Changed" Unchecked="LayerChip_Changed">
                        <StackPanel Orientation="Horizontal">
                            <Border Width="16" Height="16" Margin="0,0,5,0" CornerRadius="8">
                                <Border.Clip>
                                    <EllipseGeometry Center="8,8" RadiusX="8" RadiusY="8"/>
                                </Border.Clip>
                                <Image Source="/Assets/DB/Icons/BOSS Spawn.webp" Stretch="UniformToFill"/>
                            </Border>
                            <TextBlock Text="Boss" FontSize="10" Foreground="{StaticResource TextPrimary}"/>
                        </StackPanel>
                    </ToggleButton>
                    <ToggleButton x:Name="ChipExtract" Style="{StaticResource LayerChipStyle}"
                                  IsChecked="True" Checked="LayerChip_Changed" Unchecked="LayerChip_Changed">
                        <StackPanel Orientation="Horizontal">
                            <Border Width="16" Height="16" Margin="0,0,5,0" CornerRadius="8">
                                <Border.Clip>
                                    <EllipseGeometry Center="8,8" RadiusX="8" RadiusY="8"/>
                                </Border.Clip>
                                <Image Source="/Assets/DB/Icons/PMC Extraction.webp" Stretch="UniformToFill"/>
                            </Border>
                            <TextBlock Text="Extract" FontSize="10" Foreground="{StaticResource TextPrimary}"/>
                        </StackPanel>
                    </ToggleButton>
                    <ToggleButton x:Name="ChipTransit" Style="{StaticResource LayerChipStyle}"
                                  IsChecked="True" Checked="LayerChip_Changed" Unchecked="LayerChip_Changed">
                        <StackPanel Orientation="Horizontal">
                            <Border Width="16" Height="16" Margin="0,0,5,0" CornerRadius="8">
                                <Border.Clip>
                                    <EllipseGeometry Center="8,8" RadiusX="8" RadiusY="8"/>
                                </Border.Clip>
                                <Image Source="/Assets/DB/Icons/Transit.webp" Stretch="UniformToFill"/>
                            </Border>
                            <TextBlock Text="Transit" FontSize="10" Foreground="{StaticResource TextPrimary}"/>
                        </StackPanel>
                    </ToggleButton>
                    <ToggleButton x:Name="ChipSpawn" Style="{StaticResource LayerChipStyle}"
                                  IsChecked="False" Checked="LayerChip_Changed" Unchecked="LayerChip_Changed">
                        <StackPanel Orientation="Horizontal">
                            <Border Width="16" Height="16" Margin="0,0,5,0" CornerRadius="8">
                                <Border.Clip>
                                    <EllipseGeometry Center="8,8" RadiusX="8" RadiusY="8"/>
                                </Border.Clip>
                                <Image Source="/Assets/DB/Icons/PMC Spawn.webp" Stretch="UniformToFill"/>
                            </Border>
                            <TextBlock Text="Spawn" FontSize="10" Foreground="{StaticResource TextPrimary}"/>
                        </StackPanel>
                    </ToggleButton>
                    <ToggleButton x:Name="ChipLever" Style="{StaticResource LayerChipStyle}"
                                  IsChecked="True" Checked="LayerChip_Changed" Unchecked="LayerChip_Changed">
                        <StackPanel Orientation="Horizontal">
                            <Border Width="16" Height="16" Margin="0,0,5,0" CornerRadius="8">
                                <Border.Clip>
                                    <EllipseGeometry Center="8,8" RadiusX="8" RadiusY="8"/>
                                </Border.Clip>
                                <Image Source="/Assets/DB/Icons/Lever.webp" Stretch="UniformToFill"/>
                            </Border>
                            <TextBlock Text="Lever" FontSize="10" Foreground="{StaticResource TextPrimary}"/>
                        </StackPanel>
                    </ToggleButton>
                    <ToggleButton x:Name="ChipKeys" Style="{StaticResource LayerChipStyle}"
                                  IsChecked="False" Checked="LayerChip_Changed" Unchecked="LayerChip_Changed">
                        <StackPanel Orientation="Horizontal">
                            <Border Width="16" Height="16" Margin="0,0,5,0" CornerRadius="8">
                                <Border.Clip>
                                    <EllipseGeometry Center="8,8" RadiusX="8" RadiusY="8"/>
                                </Border.Clip>
                                <Image Source="/Assets/DB/Icons/Keys.webp" Stretch="UniformToFill"/>
                            </Border>
                            <TextBlock Text="Keys" FontSize="10" Foreground="{StaticResource TextPrimary}"/>
                        </StackPanel>
                    </ToggleButton>
                    <ToggleButton x:Name="ChipQuest" Style="{StaticResource LayerChipStyle}"
                                  IsChecked="True" Checked="LayerChip_Changed" Unchecked="LayerChip_Changed">
                        <StackPanel Orientation="Horizontal">
                            <svgc:SvgViewbox Source="Assets/DB/Icons/Quest_Mark.svg" Width="16" Height="16" Margin="0,0,5,0"/>
                            <TextBlock Text="Quest" FontSize="10" Foreground="{StaticResource TextPrimary}"/>
                        </StackPanel>
                    </ToggleButton>
                </StackPanel>
            </Border>

            <!-- ===== FLOATING: Zoom Controls (Bottom Right) ===== -->
            <Border Style="{StaticResource FloatingPanelStyle}"
                    HorizontalAlignment="Right" VerticalAlignment="Bottom"
                    Margin="0,0,16,12" Padding="4">
                <StackPanel Orientation="Horizontal">
                    <Button x:Name="BtnPanToPlayer" Style="{StaticResource IconButtonStyle}" Width="32" Height="32"
                            Click="BtnCenterPlayer_Click" ToolTip="Center on Player (P)">
                        <TextBlock Text="&#x1F3AF;" FontSize="13"/>
                    </Button>
                    <Rectangle Width="1" Height="20" Fill="{StaticResource BorderSubtle}" Margin="2,0"/>
                    <Button Style="{StaticResource IconButtonStyle}" Width="32" Height="32"
                            Click="BtnZoomIn_Click" ToolTip="Zoom In (+)">
                        <TextBlock Text="+" FontSize="16" FontWeight="Bold"/>
                    </Button>
                    <TextBlock x:Name="ZoomText" Text="100%" Width="44" TextAlignment="Center"
                               Foreground="{StaticResource Accent}" FontSize="11" FontWeight="SemiBold"
                               VerticalAlignment="Center"/>
                    <Button Style="{StaticResource IconButtonStyle}" Width="32" Height="32"
                            Click="BtnZoomOut_Click" ToolTip="Zoom Out (-)">
                        <TextBlock Text="-" FontSize="16" FontWeight="Bold"/>
                    </Button>
                    <Rectangle Width="1" Height="20" Fill="{StaticResource BorderSubtle}" Margin="2,0"/>
                    <Button Style="{StaticResource IconButtonStyle}" Width="32" Height="32"
                            Click="BtnResetView_Click" ToolTip="Reset (R)">
                        <TextBlock Text="&#x21BB;" FontSize="14"/>
                    </Button>
                    <Button Style="{StaticResource IconButtonStyle}" Width="32" Height="32"
                            Click="BtnFitView_Click" ToolTip="Fit (F)">
                        <TextBlock Text="&#x26F6;" FontSize="12"/>
                    </Button>
                </StackPanel>
            </Border>

            <!-- ===== FLOATING: Minimap (Top Right) ===== -->
            <Border x:Name="MinimapPanel" Style="{StaticResource FloatingPanelStyle}"
                    HorizontalAlignment="Right" VerticalAlignment="Top"
                    Margin="0,8,16,0" Width="140" Height="140" Visibility="Collapsed">
                <Grid>
                    <Canvas x:Name="MinimapCanvas" ClipToBounds="True"/>
                    <Border x:Name="MinimapViewport" BorderBrush="{StaticResource Accent}" BorderThickness="1"
                            HorizontalAlignment="Left" VerticalAlignment="Top" Width="40" Height="30"/>
                    <Button HorizontalAlignment="Right" VerticalAlignment="Top"
                            Style="{StaticResource IconButtonStyle}" Width="24" Height="24"
                            Click="BtnToggleMinimap_Click">
                        <TextBlock Text="&#x2715;" FontSize="10"/>
                    </Button>
                </Grid>
            </Border>

            <!-- ===== Marker Tooltip (Redesigned) ===== -->
            <Border x:Name="MarkerTooltip" Visibility="Collapsed"
                    Style="{StaticResource FloatingPanelStyle}"
                    HorizontalAlignment="Left" VerticalAlignment="Top"
                    Padding="14,12" MaxWidth="340" MinWidth="220"
                    IsHitTestVisible="False">
                <StackPanel>
                    <!-- Header with Icon -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                        <Border x:Name="TooltipIconBorder" Width="36" Height="36" CornerRadius="18"
                                Background="{StaticResource BgL3}" BorderThickness="2" BorderBrush="{StaticResource MarkerExtract}">
                            <TextBlock x:Name="TooltipIcon" Text="&#x25B2;" FontSize="16"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Foreground="{StaticResource MarkerExtract}"/>
                        </Border>
                        <StackPanel Margin="12,0,0,0" VerticalAlignment="Center">
                            <TextBlock x:Name="TooltipTitle" Text="Marker Name" FontSize="14" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextPrimary}" TextWrapping="Wrap" MaxWidth="260"/>
                            <TextBlock x:Name="TooltipType" Text="PMC Extraction" FontSize="11"
                                       Foreground="{StaticResource TextSecondary}" Margin="0,2,0,0"/>
                        </StackPanel>
                    </StackPanel>

                    <Separator Background="{StaticResource BorderSubtle}" Margin="0,0,0,10"/>

                    <!-- Details -->
                    <TextBlock x:Name="TooltipDetails" Text="" Visibility="Collapsed"
                               Foreground="{StaticResource TextSecondary}" FontSize="12" TextWrapping="Wrap" Margin="0,0,0,10"/>

                    <!-- Cluster Info (Multiple quests/markers at same location) -->
                    <StackPanel x:Name="TooltipClusterInfo" Visibility="Collapsed" Margin="0,0,0,10">
                        <TextBlock x:Name="TooltipClusterCount" Text="3 Quests at this location" FontSize="12" FontWeight="SemiBold"
                                   Foreground="{StaticResource Accent}" Margin="0,0,0,8"/>
                        <Border Background="#15FFFFFF" CornerRadius="6" Padding="8,6" Margin="0,0,0,6">
                            <ItemsControl x:Name="TooltipClusterList" MaxHeight="200">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="Transparent" Cursor="Hand" Margin="0,3"
                                                CornerRadius="4" Padding="6,4"
                                                MouseLeftButtonDown="TooltipQuestItem_Click" Tag="{Binding}">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#25FFFFFF"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <StackPanel Orientation="Horizontal">
                                                <Ellipse Width="8" Height="8" Fill="{Binding TypeColorBrush}" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                                <TextBlock Text="{Binding QuestName}" FontSize="12" Foreground="{StaticResource TextPrimary}"
                                                           TextTrimming="CharacterEllipsis" MaxWidth="240" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Border>
                        <TextBlock x:Name="TooltipClusterTypes" Text="" FontSize="10"
                                   Foreground="{StaticResource TextMuted}" TextWrapping="Wrap" Margin="0,2,0,0"/>
                    </StackPanel>

                    <!-- Coordinates -->
                    <TextBlock x:Name="TooltipCoords" Text="X: 0, Z: 0" FontSize="11"
                               Foreground="{StaticResource TextMuted}"/>
                </StackPanel>
            </Border>

            <!-- Loading Indicator -->
            <Border x:Name="LoadingIndicator" Visibility="Collapsed"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    Style="{StaticResource FloatingPanelStyle}" Padding="20,12">
                <StackPanel Orientation="Horizontal">
                    <ProgressBar IsIndeterminate="True" Width="80" Height="3" Foreground="{StaticResource Accent}"/>
                    <TextBlock x:Name="LoadingText" Text="Loading..." Margin="12,0,0,0"
                               Foreground="{StaticResource TextSecondary}" FontSize="11" VerticalAlignment="Center"/>
                </StackPanel>
            </Border>

            <!-- No Map Message -->
            <TextBlock x:Name="NoMapMessage" Text="Select a map" Visibility="Visible"
                       HorizontalAlignment="Center" VerticalAlignment="Center"
                       Foreground="{StaticResource TextMuted}" FontSize="14"/>

            <!-- Shortcuts Popup -->
            <Border x:Name="ShortcutsPopup" Visibility="Collapsed"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    Style="{StaticResource FloatingPanelStyle}" Padding="20,16" MinWidth="280">
                <StackPanel>
                    <Grid Margin="0,0,0,12">
                        <TextBlock Text="Keyboard Shortcuts" FontSize="14" FontWeight="SemiBold"
                                   Foreground="{StaticResource TextPrimary}"/>
                        <Button x:Name="BtnCloseShortcuts" Content="&#x2715;" Click="BtnCloseShortcuts_Click"
                                HorizontalAlignment="Right" Style="{StaticResource IconButtonStyle}" Width="28" Height="28"/>
                    </Grid>
                    <Separator Background="{StaticResource BorderSubtle}" Margin="0,0,0,12"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="60"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition/><RowDefinition/><RowDefinition/><RowDefinition/>
                            <RowDefinition/><RowDefinition/><RowDefinition/><RowDefinition/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Space" Foreground="{StaticResource Accent}" FontWeight="SemiBold" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="Start/Stop Tracking" Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="A" Foreground="{StaticResource Accent}" FontWeight="SemiBold" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="Toggle Auto-follow" Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="P / F" Foreground="{StaticResource Accent}" FontWeight="SemiBold" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="Pan to Player / Fit" Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Q" Foreground="{StaticResource Accent}" FontWeight="SemiBold" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="3" Grid.Column="1" Text="Toggle Quest Panel" Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="4" Grid.Column="0" Text="+/-" Foreground="{StaticResource Accent}" FontWeight="SemiBold" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="4" Grid.Column="1" Text="Zoom In/Out" Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="5" Grid.Column="0" Text="1-7" Foreground="{StaticResource Accent}" FontWeight="SemiBold" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="5" Grid.Column="1" Text="Toggle Layers" Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="6" Grid.Column="0" Text="R" Foreground="{StaticResource Accent}" FontWeight="SemiBold" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="6" Grid.Column="1" Text="Reset View" Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="7" Grid.Column="0" Text="Esc" Foreground="{StaticResource Accent}" FontWeight="SemiBold" FontSize="11" Margin="0,2"/>
                        <TextBlock Grid.Row="7" Grid.Column="1" Text="Close Popups" Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,2"/>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Settings Panel (Slide-out) -->
            <Border x:Name="SettingsOverlay" Visibility="Collapsed" Background="#60000000"
                    MouseLeftButtonDown="SettingsOverlay_MouseLeftButtonDown"/>
            <Border x:Name="SettingsPanel" Visibility="Collapsed" Width="280"
                    HorizontalAlignment="Right" VerticalAlignment="Stretch"
                    Background="{StaticResource BgL2}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1,0,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Border Grid.Row="0" Background="{StaticResource BgL3}" Padding="12,10">
                        <Grid>
                            <TextBlock Text="Settings" FontSize="14" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextPrimary}"/>
                            <Button x:Name="BtnCloseSettings" Content="&#x2715;" Click="BtnCloseSettings_Click"
                                    HorizontalAlignment="Right" Style="{StaticResource IconButtonStyle}" Width="28" Height="28"/>
                        </Grid>
                    </Border>
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="12">
                        <StackPanel>
                            <TextBlock Text="QUEST OBJECTIVES" FontSize="10" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextSecondary}" Margin="0,0,0,12"/>
                            <CheckBox x:Name="ChkHideCompletedObjectives" Content="Hide completed objectives" IsChecked="False" Margin="0,4"
                                      Foreground="{StaticResource TextPrimary}" FontSize="11"
                                      Checked="ChkHideCompletedObjectives_Changed" Unchecked="ChkHideCompletedObjectives_Changed"/>
                            <TextBlock Text="Completed objectives will be hidden from the map"
                                       FontSize="10" Foreground="{StaticResource TextMuted}" Margin="20,4,0,0" TextWrapping="Wrap"/>

                            <!-- Extract Markers Section -->
                            <Rectangle Height="1" Fill="{StaticResource BorderSubtle}" Margin="0,16,0,12"/>
                            <TextBlock Text="EXTRACT MARKERS" FontSize="10" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextSecondary}" Margin="0,0,0,12"/>
                            <CheckBox x:Name="ChkShowPmcExtracts" Content="Show PMC Extracts" IsChecked="True" Margin="0,4"
                                      Foreground="{StaticResource TextPrimary}" FontSize="11"
                                      Checked="ChkShowPmcExtracts_Changed" Unchecked="ChkShowPmcExtracts_Changed"/>
                            <CheckBox x:Name="ChkShowScavExtracts" Content="Show Scav Extracts" IsChecked="True" Margin="0,4"
                                      Foreground="{StaticResource TextPrimary}" FontSize="11"
                                      Checked="ChkShowScavExtracts_Changed" Unchecked="ChkShowScavExtracts_Changed"/>
                            <TextBlock Text="Shared extracts are always visible when either option is enabled"
                                       FontSize="10" Foreground="{StaticResource TextMuted}" Margin="20,4,0,0" TextWrapping="Wrap"/>

                            <!-- Screenshot Path Section -->
                            <Rectangle Height="1" Fill="{StaticResource BorderSubtle}" Margin="0,16,0,12"/>
                            <TextBlock Text="SCREENSHOT TRACKING" FontSize="10" FontWeight="SemiBold"
                                       Foreground="{StaticResource TextSecondary}" Margin="0,0,0,12"/>
                            <TextBlock Text="Screenshot folder path"
                                       FontSize="11" Foreground="{StaticResource TextPrimary}" Margin="0,0,0,6"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="TxtScreenshotPath" Grid.Column="0"
                                         FontSize="10" Padding="6,4" IsReadOnly="True"
                                         Background="{StaticResource BgL1}" Foreground="{StaticResource TextSecondary}"
                                         BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                         VerticalContentAlignment="Center"/>
                                <Button x:Name="BtnBrowseScreenshotPath" Grid.Column="1" Content="..." Width="28" Height="24" Margin="4,0,0,0"
                                        Click="BtnBrowseScreenshotPath_Click"
                                        Background="{StaticResource BgL3}" Foreground="{StaticResource TextPrimary}"
                                        BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"/>
                            </Grid>
                            <TextBlock Text="Leave empty for auto-detection (Documents\Escape from Tarkov\Screenshots)"
                                       FontSize="9" Foreground="{StaticResource TextMuted}" Margin="0,4,0,0" TextWrapping="Wrap"/>
                            <Button x:Name="BtnResetScreenshotPath" Content="Reset to Auto-Detect" Margin="0,8,0,0"
                                    Click="BtnResetScreenshotPath_Click" HorizontalAlignment="Left"
                                    Padding="8,4" FontSize="10"
                                    Background="{StaticResource BgL3}" Foreground="{StaticResource TextSecondary}"
                                    BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"/>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>

                <!-- Hidden: Layer Menu Popup (for backward compatibility) -->
                <Border x:Name="LayerMenuPopup" Visibility="Collapsed"/>
            </Grid>
        </Grid>

        <!-- ==================== COMPACT STATUS BAR (32px) ==================== -->
        <Border Grid.Row="2" Background="{StaticResource BgL2}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="0,1,0,0">
            <Grid Margin="12,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>  <!-- Tracking -->
                    <ColumnDefinition Width="Auto"/>  <!-- Sep -->
                    <ColumnDefinition Width="*"/>     <!-- Coords -->
                    <ColumnDefinition Width="Auto"/>  <!-- Sep -->
                    <ColumnDefinition Width="Auto"/>  <!-- Markers -->
                    <ColumnDefinition Width="Auto"/>  <!-- Toggle -->
                </Grid.ColumnDefinitions>

                <!-- Tracking Button -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button x:Name="BtnStartTracking" Style="{StaticResource TrackingButtonStyle}"
                            Background="{StaticResource Success}" Foreground="White"
                            Click="WatcherToggleButton_Click" ToolTip="Space">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock x:Name="TxtStartIcon" Text="&#x25B6;" FontSize="9" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBlock x:Name="TxtStartText" Text="Start" FontSize="11"/>
                        </StackPanel>
                    </Button>
                    <ToggleButton x:Name="BtnAutoFollow" Width="48" Height="24" Margin="8,0,0,0" Cursor="Hand"
                                  Background="{StaticResource BgL3}" Foreground="{StaticResource TextSecondary}"
                                  BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                  Checked="BtnAutoFollow_Checked" Unchecked="BtnAutoFollow_Unchecked" ToolTip="A">
                        <TextBlock Text="Auto" FontSize="10"/>
                    </ToggleButton>
                </StackPanel>

                <Rectangle Grid.Column="1" Width="1" Height="18" Fill="{StaticResource BorderSubtle}" Margin="12,0"/>

                <!-- Player Coords -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Center">
                    <Ellipse x:Name="WatcherIndicator" Width="6" Height="6" Fill="{StaticResource TextMuted}" Margin="0,0,8,0"/>
                    <TextBlock Text="&#x1F4CD;" FontSize="11" Margin="0,0,6,0"/>
                    <TextBlock x:Name="PlayerPositionText" Text="X: --  Z: --"
                               Foreground="{StaticResource PlayerMarker}" FontSize="11" FontFamily="Consolas"/>
                </StackPanel>

                <Rectangle Grid.Column="3" Width="1" Height="18" Fill="{StaticResource BorderSubtle}" Margin="12,0"/>

                <!-- Visible Markers -->
                <StackPanel Grid.Column="4" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="&#x1F441;" FontSize="11" Margin="0,0,6,0"/>
                    <TextBlock x:Name="MarkerCountText" Text="0" Foreground="{StaticResource Accent}" FontWeight="SemiBold" FontSize="11"/>
                    <TextBlock x:Name="TotalMarkerCountText" Text="/0" Foreground="{StaticResource TextMuted}" FontSize="11"/>
                </StackPanel>

                <!-- Quest Panel Toggle -->
                <Button Grid.Column="5" x:Name="BtnToggleQuestPanel" Width="28" Height="24" Margin="12,0,0,0"
                        Style="{StaticResource IconButtonStyle}" Click="BtnToggleQuestPanel_Click" ToolTip="Q">
                    <TextBlock x:Name="TxtQuestPanelToggle" Text="&#x25C0;" FontSize="10"/>
                </Button>
            </Grid>
        </Border>
    </Grid>
</UserControl>
